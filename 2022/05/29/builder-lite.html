<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Builder Lite</title>
  <meta name="description"
    content="In this short post, I describe and name a cousin of the builder pattern&#8201;&#8212;&#8201;builder lite.">
  <link rel="canonical" href="https://matklad.github.io//2022/05/29/builder-lite.html">
  <link rel="alternate" type="application/rss+xml" title="matklad" href="https://matklad.github.io//feed.xml">

  <style>
    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Regular.woff2') format('woff2');
    }

    @font-face {
      font-family: 'JetBrains Mono';
      src: url('/css/JetBrainsMono-Bold.woff2') format('woff2');
      ;
      font-weight: bold;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      margin-block-start: 0;
      margin-block-end: 0;
    }

    h1,
    h2,
    h3 {
      font-weight: 300;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    main {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 80ch;
      padding-left: 2ch;
      padding-right: 2ch;
    }

    .site-header {
      width: 100%;
      max-width: 80ch;
      margin-bottom: 1.5rem;
    }

    .site-header>nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
    }

    .site-header .-title {
      flex-grow: 2;
    }

    .site-footer {
      display: flex;
      justify-content: center;
      align-items: baseline;
      width: 100%;
      max-width: 80ch;
      margin-top: 1rem;
      height: 2rem;
      padding-left: 1ch;
      padding-right: 1ch;
    }
  </style>
  <link rel="stylesheet" href=" /css/adoc.css">
  <link rel="stylesheet" href=" /css/rouge-github.css">
  <link rel="stylesheet" href=" /css/main.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=EB+Garamond:400,400italic,700,700italic%7COpen+Sans:300">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>
  <header class="site-header">
    <nav>
      <a class="-title" href="/">matklad</a>
      
      
      <a href="/about/">About</a>
      
      
      
      
      
      <a href="/resume/">Resume</a>
      
      
      
      
      
      
      
      
      
      
    </nav>
  </header>

  <main>
    <article>
  <h1>Builder Lite</h1>
  <div class="post-meta sect1">May 29, 2022</div>
  <div class="paragraph">
<p>In this short post, I describe and name a cousin of the builder pattern&#8201;&#8212;&#8201;builder lite.</p>
</div>
<div class="paragraph">
<p>Unlike a traditional builder, which uses a separate builder object, builder lite re-uses the object itself to provide builder functionality.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an illustrative example</p>
</div>
<div class="listingblock">
<div class="title">Builder Lite</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">Shape</span> <span class="p">{</span>
  <span class="n">position</span><span class="p">:</span> <span class="n">Vec3</span><span class="p">,</span>
  <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span>
  <span class="n">material</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Shape</span> <span class="p">{</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Shape</span> <span class="p">{</span>
    <span class="n">Shape</span> <span class="p">{</span>
      <span class="n">position</span><span class="p">:</span> <span class="nn">Vec3</span><span class="p">::</span><span class="nf">default</span><span class="p">(),</span>
      <span class="n">geometry</span><span class="p">,</span>
      <span class="n">material</span><span class="p">:</span> <span class="nb">None</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">with_position</span><span class="p">(</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">Vec3</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Shape</span> <span class="p">{</span>
    <span class="k">self</span><span class="py">.position</span> <span class="o">=</span> <span class="n">position</span><span class="p">;</span>
    <span class="k">self</span>
  <span class="p">}</span>

  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">with_material</span><span class="p">(</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">material</span><span class="p">:</span> <span class="n">Material</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Shape</span> <span class="p">{</span>
    <span class="k">self</span><span class="py">.material</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="n">material</span><span class="p">);</span>
    <span class="k">self</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Call site</span>

<span class="k">let</span> <span class="n">shape</span> <span class="o">=</span> <span class="nn">Shape</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Geometry</span><span class="p">::</span><span class="nn">Sphere</span><span class="p">::</span><span class="nf">with_radius</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
  <span class="nf">.with_position</span><span class="p">(</span><span class="nf">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
  <span class="nf">.with_material</span><span class="p">(</span><span class="nn">Material</span><span class="p">::</span><span class="nf">SolidColor</span><span class="p">(</span><span class="nn">Color</span><span class="p">::</span><span class="n">Red</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In contrast, the full builder is significantly wordier at the definition site, and requires a couple of extra invocations at the call site:</p>
</div>
<div class="listingblock">
<div class="title">Builder</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">Shape</span> <span class="p">{</span>
  <span class="n">position</span><span class="p">:</span> <span class="n">Vec3</span><span class="p">,</span>
  <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span>
  <span class="n">material</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Material</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">ShapeBuilder</span> <span class="p">{</span>
  <span class="n">position</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Vec3</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">geometry</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Geometry</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">texture</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Texture</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Shape</span> <span class="p">{</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">builder</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">ShapeBuilder</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">ShapeBuilder</span> <span class="p">{</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">position</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">Vec3</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">Self</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">geometry</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">Self</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">material</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">material</span><span class="p">:</span> <span class="n">Material</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="k">Self</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">build</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Shape</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Call site</span>

<span class="k">let</span> <span class="n">shape</span> <span class="o">=</span> <span class="nn">Shape</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
  <span class="nf">.position</span><span class="p">(</span><span class="nf">Vec3</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
  <span class="nf">.geometry</span><span class="p">(</span><span class="nn">Geometry</span><span class="p">::</span><span class="nn">Sphere</span><span class="p">::</span><span class="nf">with_radius</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
  <span class="nf">.material</span><span class="p">(</span><span class="nn">Material</span><span class="p">::</span><span class="nf">SolidColor</span><span class="p">(</span><span class="nn">Color</span><span class="p">::</span><span class="n">Red</span><span class="p">))</span>
  <span class="nf">.build</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The primary benefit of builder-lite is that it is an incremental, zero-cost evolution from the <code>new</code> method.
As such, it is especially useful in the context where the code evolves rapidly, in an uncertain direction.
That is, when building applications rather than library.</p>
</div>
<div class="paragraph">
<p>To pull a motivational example from work, we had the following typical code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="k">impl</span> <span class="n">PeerManagerActor</span> <span class="p">{</span>
  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">NetworkConfig</span><span class="p">,</span>
    <span class="n">client_addr</span><span class="p">:</span> <span class="n">Recipient</span><span class="o">&lt;</span><span class="n">NetworkClientMessages</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">view_client_addr</span><span class="p">:</span> <span class="n">Recipient</span><span class="o">&lt;</span><span class="n">NetworkViewClientMessages</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">routing_table_addr</span><span class="p">:</span> <span class="n">Addr</span><span class="o">&lt;</span><span class="n">RoutingTableActor</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;</span> <span class="p">{</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a <code>new</code> method with a whole bunch of arguments for various dependencies.
What we needed to do is to add yet another dependency, so that it could be overwritten in tests.
The first attempt just added one more parameter to the <code>new</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>  <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">NetworkConfig</span><span class="p">,</span>
    <span class="n">client_addr</span><span class="p">:</span> <span class="n">Recipient</span><span class="o">&lt;</span><span class="n">NetworkClientMessages</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">view_client_addr</span><span class="p">:</span> <span class="n">Recipient</span><span class="o">&lt;</span><span class="n">NetworkViewClientMessages</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">routing_table_addr</span><span class="p">:</span> <span class="n">Addr</span><span class="o">&lt;</span><span class="n">RoutingTableActor</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">+</span>   <span class="n">ping_counter</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span> <span class="n">PingCounter</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;</span> <span class="p">{</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this change required update of the seven call-sites where the <code>new</code> was called to supply the default counter.
Switching that to builder lite allowed us to only modify a single call-site where we cared to override the counter.</p>
</div>
<div class="paragraph">
<div class="title">A note on naming:</div>
<p>If builder methods are to be used only occasionally, <code>with_foo</code> is the best naming.
If most call-sites make use of builder methods, just <code>.foo</code> might work better.
For boolean properties, sometimes it makes sense to have both:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">fancy</span><span class="p">(</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
  <span class="k">self</span><span class="nf">.with_fancy</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">with_fancy</span><span class="p">(</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">yes</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
  <span class="k">self</span><span class="py">.fancy</span> <span class="o">=</span> <span class="n">yes</span><span class="p">;</span>
  <span class="k">self</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Discussion on <a href="https://old.reddit.com/r/rust/comments/v07kac/blog_post_builder_lite/">/r/rust</a>.</p>
</div>
</article>

  </main>

  <footer class="site-footer">
    <p>
      <a href="https://github.com/matklad/matklad.github.io/edit/master/_posts/2022-05-29-builder-lite.adoc">
        <i class="fa fa-edit"></i> fix typo
      </a>

      <a href=" /feed.xml">
        <i class="fa fa-rss"></i> rss
      </a>

      <a href="https://github.com/matklad">
        <i class="fa fa-github"></i> matklad
      </a>
    </p>
  </footer>
</body>

</html>
